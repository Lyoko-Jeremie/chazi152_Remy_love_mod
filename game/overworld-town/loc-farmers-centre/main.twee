:: Farmers Centre
<<set $outside to 0>><<set $location to "factory">><<effects>>
<<if $farmersProduce is undefined>>
	<<set $farmersProduce to {
		selling:{},
		toSell:{},
		money:0,
		sold:0,
		totalSold:0,
	}>>
<</if>>

<<if !$NPCList[0].pronoun>>
	<<generate1>>
<</if>>
<<person1>>

<<if $factory_intro is undefined>>
	<<set $factory_intro to 1>>
	你走向工厂，这是座位于城镇入口处的巨大建筑。你看见一个<<person>>正站在门口指挥着一队卡车进入。
	<br><br>
	<<He>>在大门关上的时候才转向了你。 "这里没什么好看的，"<<he>>继续说道， "除非你有很多的作物要卖，否则你最好不要在这附近晃荡。如果你想要交易的话，你可以来找我。我们会收购你手里的所有作物，但是价格会低于市场价。"
	<br><br>
	<<link [[继续|Farmers Centre]]>><</link>>
	<br>
<<else>>
	你正待在丰收街一家工厂的外面，他们收购你的作物用作加工和销售。虽然确实能很快的将作物卖出去，但是每株作物的收购价并没有你摆摊的零售价格高。
	<br><br>

	<<if $rng gte 91>>
		一个<<person>>正坐在外面的问讯亭里翻阅着杂志。
	<<elseif $rng gte 81>>
		一个<<person>>正靠在墙边抽烟。
	<<elseif $rng gte 71>>
		一个<<person>>正坐在问讯亭内，你注意到<<He>>正全神贯注地盯着角落里的一台小电视机。
	<<elseif $rng gte 61>>
		一个<<person>>正坐在问讯亭里盯着<<his>>的手机。
	<<elseif $rng gte 51>>
		一个<<person>>正在指挥着一队卡车进入工厂。
	<<elseif $rng gte 41>>
		一个<<person>>坐在外面的问讯亭里，<<his>>貌似在和谁打电话。
	<<elseif $rng gte 31>>
		一个<<person>>正坐在外面的问讯亭里翻阅着报纸。
	<<elseif $rng gte 21>>
		一个<<person>>靠在墙边盯着那来来往往的车辆。
	<<elseif $rng gte 11>>
		一个<<person>>正站在问讯亭里看着你。
	<<else>>
		一个<<person>>斜倚在问讯亭内的椅子上。
	<</if>>
	<br><br>

	<<if $farmersProduce.money gt 10000>>
		<<link [[收钱|Farmers Centre Money Collection]]>><</link>>
		<br>
	<</if>>
	<<link [[询问作物销售|Farmers Centre Produce Sale]]>><</link>>
	<br><br>
	<<link [[离开|Harvest Street]]>><<endevent>><</link>>

<</if>>

:: Farmers Centre Money Collection

<<person>>走进工厂。在等了一会后，<<He>>带着一沓纸币走了出来。你这次赚了<<moneyGain `(parseFloat($farmersProduce.money / 100).toFixed(2))`>>。
<<set $farmersProduce.money to 0>>
<br><br>
<<link [[离开|Farmers Centre]]>><</link>>

:: Farmers Centre Produce Sale
<<person>>打开笔记本电脑。 "你有什么想卖的？"
<br><br>
<i>销售收入可以在每天中午收取，更高的商业声誉将有助于工厂更快地销售产品。</i>
<br><br>
<<set $farmersProduce.toSell to {}>>
<<set _plant_keys to Object.keys($plants)>>
<<set _plantItems to {}>>
<<if _plant_keys.length gte 1>>
	<<for _i to 0; _i lt _plant_keys.length; _i++>>
		<<if ["produce","vegetable","fruit","shroom"].includes(setup.plants[_plant_keys[_i]].type)>>
			<<set _plantItems[_plant_keys[_i]] to clone($plants[_plant_keys[_i]])>>
		<</if>>
	<</for>>
	<div id="produceDisplay">
		<<produceDisplay>>
	</div>
<<else>>
	你没有任何农产品。
	<br><br>
<</if>>
<br><br>
<<link [[离开|Farmers Centre]]>><<set $farmersProduce.toSell to {}>><</link>>

:: Farmers Centre Produce Sale Confirm

大门强烈震动着，一辆轰鸣着的卡车开了出来。这辆车是来收集你要卖的作物的。
<br><br>
<<link [[离开|Farmers Centre]]>><</link>>


:: Farmers Centre Widgets [widget]
<<widget "produceDisplay">>
	<<set _listMaxItems to 10>>
	<<set _keys to (Object.keys(_plantItems) gt Object.keys($farmersProduce.toSell) ? Object.keys(_plantItems) : Object.keys($farmersProduce.toSell))>>
	<<if _listPage is undefined>>
		<<set _listPage to 1>>
	<</if>>
	<<set _listPageMax to Math.ceil(_keys.length / _listMaxItems)>>
	<<set _indexStart to ((_listPage - 1) * _listMaxItems)>>
	<<set _indexEnd to (_indexStart + _listMaxItems gt _keys.length ? _keys.length : _indexStart + _listMaxItems)>>

	<<for _i to _indexStart; _i lt _indexEnd; _i++>>
		<<set _item to _keys[_i]>>
		<div @id="'produceItem-'+_item" class="produceItem">
			<<produceDisplayItem _item>>
		</div>
	<</for>>
	<<run $(() => {
		$('.produceItem input').on('input change', e => {
			let valSpan = $(e.currentTarget).siblings().first();
			let item = e.currentTarget.id.split("producetosell")[1].replace(/-/g,"_");
			let value = valSpan.text();
			if(!value.includes("£")){
				valSpan.text((i, value) => value + " - £" + (bulkProduceValue(SugarCube.setup.plants[item],value) / 100).toFixed(2));
				$('#produceConfirm').replaceWith(new Wikifier(null, '<<produceDisplayConfirm>>').output);
			}
		})
	})>>
	<div id="produceDisplayControls">
		<<set _disabled = _listPage > 1 ? "" : "disabled">>
		<div @class="'div-link btn-pagination prev ' + _disabled">
			<<link "上一个">>
				<<if _listPage > 1>>
					<<set _listPage -= 1>>
					<<replace #produceDisplay>><<produceDisplay>><</replace>>
				<</if>>
			<</link>>
			<div class="btn-pagination-arrow">&lt;</div>
		</div>
		<div>
			<<print (_listPage) + "/" + _listPageMax>>
		</div>
		<<set _disabled = _listPage < _listPageMax ? "" : "disabled">>
		<div @class="'div-link btn-pagination next ' + _disabled">
			<<link "下一个">>
				<<if _listPage < _listPageMax>>
					<<set _listPage += 1>>
					<<replace #produceDisplay>><<produceDisplay>><</replace>>
				<</if>>
			<</link>>
			<div class="btn-pagination-arrow">&gt;</div>
		</div>
	</div>
	<<run linkifyDivs('#produceDisplayControls')>>

	<<produceDisplayConfirm>>
<</widget>>

<<widget "produceDisplayConfirm">>
	<div id="produceConfirm">
		<<set $_total to 0>>
		<<for _label, _value range $farmersProduce.toSell>>
			<<if _value gt 0>>
				<<set $_total += bulkProduceValue(SugarCube.setup.plants[_label],_value)>>
			<</if>>
		<</for>>
		总计：<<printmoney $_total>>
		<br>
		<<if $_total gt 0>>
			<<link [[卖掉作物|Farmers Centre Produce Sale Confirm]]>>
				<<for _label, _value range $farmersProduce.toSell>>
					<<if _value gt 0>>
						<<if $farmersProduce.selling[_label] is undefined>>
							<<set $farmersProduce.selling[_label] to _value>>
						<<else>>
							<<set $farmersProduce.selling[_label] += _value>>
						<</if>>
						<<set $plants[_label].amount -= _value>>
					<</if>>
				<</for>>
				<<set $farmersProduce.toSell to {}>>
			<</link>>
		<<else>>

		<</if>>
	</div>
<</widget>>

<<widget "produceDisplayItem">>
	<<if _args[0]>>
		<<set _item to _args[0]>>
		<<capture _item>>
			<div>
				<<if $farmersProduce.toSell[_item] is undefined>>
					<<set $farmersProduce.toSell[_item] to 0>>
				<</if>>
				<<if $plants[_item] is undefined>>
					你现在没有任何的<<print $plants[_item].plural>>。
				<<elseif $plants[_item].amount lt 250>>
					<<print $plants[_item].plural>>: 不够卖。
				<<else>>
					<<set _max to $plants[_item].amount - ($plants[_item].amount % 250)>>
					<<set _base to bulkProduceValue(setup.plants[_item])>>
					<<print $plants[_item].plural>> - 以每250<<printmoney _base>>的价格出售。
					<<numberslider `"$farmersProduce.toSell['"+_item+"']"` $farmersProduce.toSell[_item] 0 `_max` 250>>
				<</if>>
			</div>
			<<if $farmersProduce.selling[_item]>>
				<div>
					那些家伙还在处理<<print $farmersProduce.selling[_item]>><<print $plants[_item].plural>>。
				</div>
			<</if>>
		<</capture>>
	<</if>>
<</widget>>

<<widget "dailySellProduce">>
	<<if $farmersProduce is undefined>>
	<<elseif Object.keys($farmersProduce.selling).length gt 0>>
		<<set _baseSaleQuantity to 250>>
		<<if between($fame.business, 1900, 2000)>>
			<<set _baseSaleQuantity to _baseSaleQuantity * 6>>
		<<elseif between($fame.business, 1500, 1900)>>
			<<set _baseSaleQuantity to _baseSaleQuantity * 5>>
		<<elseif between($fame.business, 1000, 1500)>>
			<<set _baseSaleQuantity to _baseSaleQuantity * 4>>
		<<elseif between($fame.business, 500, 1000)>>
			<<set _baseSaleQuantity to _baseSaleQuantity * 3>>
		<<elseif between($fame.business, 200, 500)>>
			<<set _baseSaleQuantity to _baseSaleQuantity * 2>>
		<</if>>
		<<set _itemsSold to 0>>
		<<for _label, _value range $farmersProduce.selling>>
			<<set _quantity to clone(_baseSaleQuantity)>>
			<<if !setup.plants[_label].season.includes(Time.season)>>
				<<set _quantity to Math.floor(_quantity * 0.9)>>
			<</if>>
			<<set _rng to 800 + Math.floor(currentSkillValue('tending') / 5)>>
			<<set _quantity to Math.floor(_quantity * (random(_rng,_rng + 400)/1000))>>
			<<if _value lt _quantity>>
				<<set _quantity to _value>>
			<</if>>
			<<set $farmersProduce.sold += _quantity>>
			<<set $farmersProduce.totalSold += _quantity>>

			<<set $farmersProduce.money += bulkProduceValue(setup.plants[_label],_quantity)>>
			<<set $farmersProduce.selling[_label] -= _quantity>>

			<<if $farmersProduce.selling[_label] lte 0>>
				<<run delete $farmersProduce.selling[_label]>>
			<</if>>
		<</for>>
		<<if $farmersProduce.sold gt 5000>>
			<<set _famebusinessSold to $farmersProduce.sold - ($farmersProduce.sold % 5000)>>
			<<set $farmersProduce.sold -= _famebusinessSold>>
			<<famebusiness `Math.floor(_famebusinessSold / 5000)`>>
		<</if>>
	<</if>>
<</widget>>
